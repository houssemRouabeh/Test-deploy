<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="/public/img/favicon.ico"
      type="image/x-icon"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&family=Karla:wght@700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <title>GREEN ROOTS - Dashboard</title>
  </head>
  <body class="body">
    <div class="container">
      <header>
        <div class="nav">
          <a class="nav_logo_link" href="/">
            <img
              class="nav_logo_img"
              src="/img/1-removebg-preview.png"
              alt="logo green roots"
            />
          </a>
          <nav class="navbar">
            <ul class="navbar_ul">
              <li class="navbar_li">
                <a class="navbar_link" href="/">ACCUEIL</a>
              </li>
              <li class="navbar_li">
                <a class="navbar_link" href="/catalogue">CATALOGUE D'ARBRES</a>
              </li>
              <li class="navbar_li">
                <a class="navbar_link" href="/campagnes">CAMPAGNES</a>
              </li>
              <li class="navbar_li">
                <a class="navbar_link" href="/apropos">À PROPOS</a>
              </li>
            </ul>
          </nav>
        </div>
        <div class="nav_button">
          <a class="login_button" id="authButton" href="/login">Se connecter</a>

          <a id="basketButton" class="basket_button" href="/panier">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="26"
              height="26"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.16 14l.84-2h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0019 3H6.21l-.94-2H1v2h2l3.6 7.59-1.35 2.45C4.52 13.37 5.48 15 7 15h12v-2H7.16z"
              />
            </svg>
            <span class="basket-count">0</span>
          </a>
        </div>
      </header>

      <main class="dashboard-main-container" 
        <aside class="dashboard-sidebar">
          <div class="user-profile">
            <img src="/img/favicon.ico" alt="Avatar Utilisateur" />
            <h2>Bonjour, <%- user.firstName %></h2>
          </div>

          <ul class="dashboard-menu">
            <li>
              <a
                href="/user/dashboard"
                class="dashboard-menu-link <%= currentPage === 'myTrees' ? 'active' : '' %>"
              >
                <i class="fas fa-leaf" style="display: none"></i>
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  style="margin-right: 10px"
                >
                  <path
                    fill="currentColor"
                    d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8Z"
                  />
                </svg>
                <span>Mes arbres plantés</span>
              </a>
            </li>
            <li>
              <a
                href="/user/dashboard/sell-history"
                class="dashboard-menu-link <%= currentPage === 'sellHistory' ? 'active' : '' %>"
              >
                <svg
                  class="sidebar-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                >
                  <path
                    fill="currentColor"
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"
                  />
                </svg>
                <span>Historique d'achats</span>
              </a>
            </li>
            <li>
              <a
                href="/user/dashboard/campaigns"
                class="dashboard-menu-link <%= currentPage === 'campaigns' ? 'active' : '' %>"
              >
                <svg
                  class="sidebar-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 512 512"
                >
                  <path
                    fill="currentColor"
                    d="M448 256A192 192 0 1 0 64 256a192 192 0 1 0 384 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm256 80a80 80 0 1 0 0-160 80 80 0 1 0 0 160zm0-224a144 144 0 1 1 0 288 144 144 0 1 1 0-288zM224 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"
                  />
                </svg>
                <span> Campagnes Soutenues</span>
              </a>
            </li>
            <li>
              <a
                href="/user/dashboard/profile"
                class="dashboard-menu-link <%= currentPage === 'profile' ? 'active' : '' %>"
              >
                <svg
                  class="sidebar-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                >
                  <path
                    fill="currentColor"
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                  />
                </svg>
                <span>Modifier mon profil</span>
              </a>
            </li>
          </ul>

          <form action="/logout" method="POST" class="logout-form">
            <button type="submit" class="logout-button">Déconnexion</button>
          </form>
        </aside>

        <div class="dashboard-content-wrapper">
          <div class="dashboard-content">
            <!-- Le contenu dynamique sera injecté ici -->
            <%- include(`./${currentPage}`) %>
          </div>

          <footer class="dashboard-footer">
            <p>&copy; 2024 MonSiteWeb. Tous droits réservés.</p>
            <ul class="footer_link_ul">
              <li class="footer_link_li">
                <a class="footer_link" href="/mentions-legales"
                  >Mentions légales</a
                >
              </li>
              <li class="footer_link_li">
                <a class="footer_link" href="/confidentialite"
                  >Politique de confidentialité</a
                >
              </li>
              <li class="footer_link_li">
                <a class="footer_link" href="/contact">Contact</a>
              </li>
            </ul>
          </footer>
        </div>
      </main>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const authButton = document.getElementById("authButton");
        const basketCount = document.querySelector(".basket-count");

        // Met à jour le panier
        const reservations =
          JSON.parse(localStorage.getItem("treeReservations")) || [];
        const totalQty = reservations.reduce(
          (sum, item) => sum + item.quantity,
          0
        );
        if (basketCount) basketCount.textContent = totalQty;

        // Vérifie si l'utilisateur est connecté
        try {
          const res = await fetch("/api/me", {
            credentials: "include",
          });

          if (!res.ok) throw new Error("Utilisateur non connecté");

          const user = await res.json();

          // Crée le HTML pour l'avatar utilisateur
          const avatarHTML = `
            <a href="/${user.role}/dashboard" class="user-avatar">
              <img src="${
                user.avatar
                  ? "/img/avatars/" + user.avatar
                  : "/img/avatars/default.png"
              }" class="avatar-icon" alt="avatar" />
              <span>${user.firstname || "Profil"}</span>
            </a>
          `;

          // Remplace le bouton de connexion
          authButton.outerHTML = avatarHTML;
        } catch (err) {
          console.warn("Non connecté ou erreur :", err.message);
        }
      });
    </script>
  </body>
</html>
<style>
  /* Styles pour le compteur du panier */
  .basket-count {
    background-color: red;
    color: white;
    font-size: 0.75em;
    padding: 2px 6px;
    border-radius: 50%;
    margin-left: -10px;
    vertical-align: top;
  }

  /* Conteneur des boutons de navigation */
  .nav_button {
    display: flex;
    align-items: center;
    gap: 20px;
    height: 100%;
  }

  /* Style du profil utilisateur */
  .user-avatar {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: inherit;
    font-size: 0.75rem;
    font-weight: bold;
    height: 80%;
    padding: 0 3px;
  }

  /* Style de l'avatar */
  .avatar-icon {
    width: 50px !important;
    height: 50px !important;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 2px;
  }

  /* Style du bouton de connexion */
  .login_button {
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 10px;
  }

  /* Style du bouton panier */
  .basket_button {
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 5px;
    position: relative;
  }

  /* Ajustement du SVG du panier */
  .basket_button svg {
    width: 24px;
    height: 24px;
  }

  /* Responsive pour petits écrans */
  @media (max-width: 768px) {
    .user-avatar span {
      display: none; /* Cache le texte sur mobile */
    }
    .avatar-icon {
      width: 30px;
      height: 30px;
    }
  }
</style>
